# Nova转发上下文插件

> 🎯 专为辉宝主人定制的合并转发消息分析插件

## ✨ 核心特性

### 1. 自动检测转发消息

支持两种场景：
- ✅ **直接发送** - 用户直接发送合并转发消息
- ✅ **回复引用** - 用户回复一条合并转发消息

### 2. 智能内容提取

| 内容类型 | 处理方式 |
|----------|----------|
| 文本 | 直接提取 |
| 图片 | placeholder/url/base64 三种模式 |
| @消息 | 转换为 [@QQ号] 格式 |
| 嵌套转发 | 递归解析（可配置深度） |

### 3. 🤖 LLM智能摘要 (新功能!)

| 特性 | 说明 |
|------|------|
| **一键摘要** | 使用选定的LLM对转发内容进行总结 |
| **提供商选择** | 支持下拉选择特定的LLM提供商 |
| **自定义提示词** | 可定制摘要生成的prompt |
| **失败回退** | 摘要失败时可自动回退到原始内容 |

### 4. 灵活的上下文注入

| 注入位置 | 说明 |
|----------|------|
| `before_user` | 在用户消息前注入（推荐） |
| `as_system` | 作为system消息注入 |
| `merge_with_user` | 合并到用户消息中 |

## 📋 使用示例

**场景：用户发送一条合并转发并询问AI**

用户操作：
1. 发送/引用一条合并转发消息
2. @AI 请帮我总结这些聊天记录

**未启用摘要时，AI收到的上下文：**
```
【转发消息记录 - 共3条】
━━━━━━━━━━━━━━━━━━━━
[张三] 今天有人看电影吗？
[李四] 我可以！[图片]
[王五] 算我一个
━━━━━━━━━━━━━━━━━━━━

用户: 请帮我总结这些聊天记录
```

**启用LLM摘要后，AI收到的上下文：**
```
【转发消息摘要 - 原始3条消息】
张三发起看电影邀约，李四和王五积极响应，三人达成一致。

用户: 请帮我总结这些聊天记录
```

## 📋 配置说明

### 基础配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| enable_forward_analysis | bool | true | 启用转发分析 |
| image_mode | string | placeholder | 图片处理模式 |
| enable_nested_forward | bool | true | 启用嵌套转发解析 |
| max_nested_depth | int | 3 | 最大嵌套深度 |
| max_messages | int | 50 | 最多提取消息条数 |
| inject_position | string | before_user | 上下文注入位置 |

### LLM摘要配置 ✨

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| enable_llm_summary | bool | false | 启用LLM摘要功能 |
| summary_provider_id | string | "" | 摘要使用的提供商(支持下拉选择) |
| summary_prompt | string | 见下方 | 摘要生成的提示词模板 |
| summary_inject_template | string | 见下方 | 摘要注入的格式模板 |
| keep_original_on_summary_fail | bool | true | 摘要失败时保留原文 |

### 格式化模板

```yaml
# 整体模板
forward_template: "【转发消息记录 - 共{count}条】\n{content}"

# 每条消息模板
message_template: "[{sender}] {text}"

# 摘要注入模板
summary_inject_template: "【转发消息摘要 - 原始{count}条消息】\n{summary}"
```

### 摘要提示词模板变量

- `{content}`: 原始转发内容
- `{count}`: 消息条数

### 摘要注入模板变量

- `{summary}`: LLM生成的摘要
- `{count}`: 原始消息条数

## ⚠️ 注意事项

1. **平台限制** - 目前仅支持 aiocqhttp 平台（QQ）
2. **API调用** - 需要bot具有 `get_forward_msg` API权限
3. **消息时效** - 转发消息可能因时间过长而无法获取
4. **LLM摘要** - 会消耗额外的API调用，建议选择稳定且快速的模型

## 🚀 使用方法

1. 将插件放入 `AstrBot/data/plugins/` 目录
2. 重启 AstrBot
3. 在控制台配置插件参数
4. （可选）启用LLM摘要并选择提供商

## 📝 更新日志

### v1.1.0
- ✨ 新增LLM智能摘要功能
- ✨ 支持下拉选择摘要提供商
- ✨ 支持自定义摘要提示词
- ✨ 摘要失败时可回退到原始内容

### v1.0.0
- 初始版本
- 支持直接发送/回复引用两种转发检测
- 支持嵌套转发递归解析
- 支持三种图片处理模式
- 支持三种上下文注入位置

---

**Made with ❤️ by Nova for 辉宝主人**